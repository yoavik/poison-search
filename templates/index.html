{% extends "base.html" %}
{% set hide_home_button = True %}
{% block content %}
<h2 class="page-title">×—×™×¤×•×© ×‘×™×˜×•×™/××™×œ×”</h2>
<form method="post" action="/search" class="card elevate">
  <label>×‘×™×˜×•×™ ×œ×—×™×¤×•×© (×¨×¦×•×™ ×‘××¨×›××•×ª):
    <input id="pm-phrase" type="text" name="phrase" placeholder='"×“×•×’××” ×œ×‘×™×˜×•×™"' required>
  </label>
  <div class="row">
    <label>××¦×‘:
      <select name="mode" id="pm-mode">
        <option value="Latest" selected>Latest</option>
        <option value="Top">Top</option>
      </select>
    </label>
    <label>××¡×¤×¨ ×ª×•×¦××•×ª ××§×¡×™××œ×™:
      <select name="max_results" id="pm-max">
        <option value="20">20</option>
        <option value="40" selected>40</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>×¡×™× ×•×Ÿ ×œ×™×™×§×™× ××™× ×™××œ×™:
      <input id="pm-minlikes" type="number" name="min_likes" value="0" min="0">
    </label>
    <label>××ª××¨×™×š:
      <input id="pm-since" type="date" name="since_date">
    </label>
    <label>×¢×“ ×ª××¨×™×š:
      <input id="pm-until" type="date" name="until_date">
    </label>
  </div>

  <div class="row">
    <label style="flex:1">
      <span class="label-line">
        ×¡×™× ×•×Ÿ ×œ×¤×™ ××©×ª××©×™× <small>(×× ×œ× ××¡×× ×™× â€” × ×—×¤×© ×‘×›×œ ×”××©×ª××©×™×)</small>
      </span>
      <div class="dropdown" id="authors-dropdown">
        <button type="button" class="dropdown-btn" aria-expanded="false" aria-controls="authors-panel">
          ×‘×—×¨ ××©×ª××©×™× (×›×•×œ×)
        </button>
        <div class="dropdown-panel" id="authors-panel" hidden>
          <div class="dropdown-actions">
            <button type="button" class="btn-ghost" onclick="pm_selectAll(true)">×‘×—×¨ ×”×›×œ</button>
            <button type="button" class="btn-ghost" onclick="pm_selectAll(false)">× ×§×” ×”×›×œ</button>
          </div>
          <div class="chk-grid" style="max-height:260px;overflow:auto;padding:.25rem 0">
            {% for a in accounts %}
            <label class="chk-item">
              <input type="checkbox" name="authors" value="{{ a }}" onchange="pm_updateSummary();pm_storeAuthors();">
              <span>@{{ a }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </label>
  </div>

    <div class="actions">
    <button class="primary" type="submit">ğŸ” ×—×¤×©</button>
  </div>
</form>

<script>
(function(){
  const dd = document.getElementById('authors-dropdown');
  const btn = dd.querySelector('.dropdown-btn');
  const panel = dd.querySelector('.dropdown-panel');
  function open() { panel.hidden = false; btn.setAttribute('aria-expanded','true'); }
  function close() { panel.hidden = true; btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.hidden ? open() : close(); });
  document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) close(); });

  function getCbs(){ return Array.from(dd.querySelectorAll('input[name="authors"]')); }

  window.pm_selectAll = function(flag){
    getCbs().forEach(cb => cb.checked = !!flag);
    pm_updateSummary();
    pm_storeAuthors();
  }
  window.pm_updateSummary = function(){
    const selected = getCbs().filter(cb => cb.checked).length;
    btn.textContent = selected ? `×‘×—×¨ ××©×ª××©×™× (${selected} × ×‘×—×¨×•)` : '×‘×—×¨ ××©×ª××©×™× (×›×•×œ×)';
  }

  // ---- Persistence (localStorage) ----
  const LS_AUTHORS = 'pm-authors';
  const LS_SINCE = 'pm-since';
  const LS_UNTIL = 'pm-until';

  window.pm_storeAuthors = function(){
    const values = getCbs().filter(cb => cb.checked).map(cb => cb.value);
    localStorage.setItem(LS_AUTHORS, JSON.stringify(values));
  }
  function restoreAuthors(){
    try {
      const raw = localStorage.getItem(LS_AUTHORS);
      if(!raw) return;
      const values = new Set(JSON.parse(raw));
      getCbs().forEach(cb => { cb.checked = values.has(cb.value); });
      pm_updateSummary();
    } catch(e){ /* ignore */ }
  }
  function storeDate(id, key){
    const el = document.getElementById(id);
    el && el.addEventListener('change', ()=> localStorage.setItem(key, el.value||''));
  }
  function restoreDate(id, key){
    const el = document.getElementById(id);
    if(!el) return;
    const v = localStorage.getItem(key);
    if(v) el.value = v;
  }

  // init
  document.addEventListener('DOMContentLoaded', ()=>{
    restoreAuthors();
    restoreDate('pm-since', LS_SINCE);
    restoreDate('pm-until', LS_UNTIL);
    storeDate('pm-since', LS_SINCE);
    storeDate('pm-until', LS_UNTIL);
  });
})();
</script>
{% endblock %}
