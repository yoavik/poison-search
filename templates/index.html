{% extends "base.html" %}
{% set hide_home_button = True %}
{% block content %}
<h2 class="page-title">חיפוש ביטוי/מילה</h2>
<form method="post" action="/search" class="card elevate">
  <label>ביטוי לחיפוש (רצוי במרכאות):
    <input type="text" name="phrase" placeholder='"דוגמה לביטוי"' required>
  </label>
  <div class="row">
    <label>מצב:
      <select name="mode">
        <option value="Latest" selected>Latest</option>
        <option value="Top">Top</option>
      </select>
    </label>
    <label>מספר תוצאות מקסימלי:
      <select name="max_results">
        <option value="20">20</option>
        <option value="40" selected>40</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>סינון לייקים מינימלי:
      <input type="number" name="min_likes" value="0" min="0">
    </label>
    <label>מתאריך:
      <input type="date" name="since_date">
    </label>
    <label>עד תאריך:
      <input type="date" name="until_date">
    </label>
  </div>

  <div class="row">
    <label style="flex:1">
      <span class="label-line">
        סינון לפי משתמשים <small>(אם לא מסמנים — נחפש בכל המשתמשים)</small>
      </span>
      <div class="dropdown" id="authors-dropdown">
        <button type="button" class="dropdown-btn" aria-expanded="false" aria-controls="authors-panel">
          בחר משתמשים (כולם)
        </button>
        <div class="dropdown-panel" id="authors-panel" hidden>
          <div class="dropdown-actions">
            <button type="button" class="btn-ghost" onclick="pm_selectAll(true)">בחר הכל</button>
            <button type="button" class="btn-ghost" onclick="pm_selectAll(false)">נקה הכל</button>
          </div>
          <div class="chk-grid" style="max-height:260px;overflow:auto;padding:.25rem 0">
            {% for a in accounts %}
            <label class="chk-item">
              <input type="checkbox" name="authors" value="{{ a }}" onchange="pm_updateSummary()">
              <span>@{{ a }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </label>
  </div>

  <details class="muted">
    <summary>חשבונות פעילים בחיפוש (תצוגה בלבד)</summary>
    <p>
      {% for a in accounts %}
        <code>@{{ a }}</code>{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  </details>
  <div class="actions">
    <button class="primary" type="submit">🔎 חפש</button>
  </div>
</form>

<script>
(function(){
  const dd = document.getElementById('authors-dropdown');
  const btn = dd.querySelector('.dropdown-btn');
  const panel = dd.querySelector('.dropdown-panel');
  function open() { panel.hidden = false; btn.setAttribute('aria-expanded','true'); }
  function close() { panel.hidden = true; btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    panel.hidden ? open() : close();
  });
  document.addEventListener('click', (e)=>{
    if(!dd.contains(e.target)) close();
  });
  window.pm_selectAll = function(flag){
    dd.querySelectorAll('input[name="authors"]').forEach(cb => cb.checked = !!flag);
    pm_updateSummary();
  }
  window.pm_updateSummary = function(){
    const cbs = Array.from(dd.querySelectorAll('input[name="authors"]'));
    const selected = cbs.filter(cb => cb.checked).length;
    btn.textContent = selected ? `בחר משתמשים (${selected} נבחרו)` : 'בחר משתמשים (כולם)';
  }
})();
</script>
{% endblock %}
