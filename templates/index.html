{% extends "base.html" %}
{% set hide_home_button = True %}
{% block content %}
<h2 class="page-title">חיפוש ביטוי/מילה</h2>
<form method="post" action="/search" class="card elevate">
  <label>ביטוי לחיפוש (רצוי במרכאות):
    <input id="pm-phrase" type="text" name="phrase" placeholder='"דוגמה לביטוי"' required>
  </label>
  <div class="row">
    <label>מצב:
      <select name="mode" id="pm-mode">
        <option value="Latest" selected>Latest</option>
        <option value="Top">Top</option>
      </select>
    </label>
    <label>מספר תוצאות מקסימלי:
      <select name="max_results" id="pm-max">
        <option value="20">20</option>
        <option value="40" selected>40</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>סינון לייקים מינימלי:
      <input id="pm-minlikes" type="number" name="min_likes" value="0" min="0">
    </label>
    <label>מתאריך:
      <input id="pm-since" type="date" name="since_date">
    </label>
    <label>עד תאריך:
      <input id="pm-until" type="date" name="until_date">
    </label>
  </div>
  <div class="row">
    <label style="align-items:center;display:flex;gap:.5rem"><input type="checkbox" name="pre_oct7" id="pm-preoct7"> רק ציוצים מלפני 7 באוקטובר 2023</label>
  </div>

  <div class="row">
    <label style="flex:1">
      <span class="label-line">
        סינון לפי משתמשים <small>(אם לא מסמנים — נחפש בכל המשתמשים)</small>
      </span>
      <div class="dropdown" id="authors-dropdown">
        <button type="button" class="dropdown-btn" aria-expanded="false" aria-controls="authors-panel">
          בחר משתמשים (כולם)
        </button>
        <div class="dropdown-panel" id="authors-panel" hidden>
          <div class="dropdown-actions">
            <button type="button" class="btn-ghost" onclick="pm_selectAll(true)">בחר הכל</button>
            <button type="button" class="btn-ghost" onclick="pm_selectAll(false)">נקה הכל</button>
          </div>
          <div class="chk-grid" style="max-height:260px;overflow:auto;padding:.25rem 0">
            {% for u in accounts_info %}
            <label class="chk-item" data-username="{{ u.username }}">
              <input type="checkbox" name="authors" value="{{ u.username }}" onchange="pm_updateSummary();pm_storeAuthors();">
              <img class="avatar avatar-sm" src="{{ u.avatar }}" alt="" loading="lazy" onerror="this.style.display='none'">
              <span class="uname">@{{ u.username }}</span>
              <span class="name small muted">{{ u.name }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </label>
  </div>

    <div class="actions">
    <button class="primary" type="submit">🔎 חפש</button>
  </div>
</form>

<script>
(function(){
  const dd = document.getElementById('authors-dropdown');
  const btn = dd.querySelector('.dropdown-btn');
  const panel = dd.querySelector('.dropdown-panel');
  function open() { panel.hidden = false; btn.setAttribute('aria-expanded','true'); }
  function close() { panel.hidden = true; btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.hidden ? open() : close(); });
  document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) close(); });

  function getCbs(){ return Array.from(dd.querySelectorAll('input[name="authors"]')); }

  window.pm_selectAll = function(flag){
    getCbs().forEach(cb => cb.checked = !!flag);
    pm_updateSummary();
    pm_storeAuthors();
  }
  window.pm_updateSummary = function(){
    const selected = getCbs().filter(cb => cb.checked).length;
    btn.textContent = selected ? `בחר משתמשים (${selected} נבחרו)` : 'בחר משתמשים (כולם)';
  }

  // ---- Persistence (localStorage) ----
  const LS_AUTHORS = 'pm-authors';
  const LS_SINCE = 'pm-since';
  const LS_UNTIL = 'pm-until';

  window.pm_storeAuthors = function(){
    const values = getCbs().filter(cb => cb.checked).map(cb => cb.value);
    localStorage.setItem(LS_AUTHORS, JSON.stringify(values));
  }
  function restoreAuthors(){
    try {
      const raw = localStorage.getItem(LS_AUTHORS);
      if(!raw) return;
      const values = new Set(JSON.parse(raw));
      getCbs().forEach(cb => { cb.checked = values.has(cb.value); });
      pm_updateSummary();
    } catch(e){ /* ignore */ }
  }
  function storeDate(id, key){
    const el = document.getElementById(id);
    el && el.addEventListener('change', ()=> localStorage.setItem(key, el.value||''));
  }
  function restoreDate(id, key){
    const el = document.getElementById(id);
    if(!el) return;
    const v = localStorage.getItem(key);
    if(v) el.value = v;
  }

  // init
  document.addEventListener('DOMContentLoaded', ()=>{

// Hydrate display names on first open
(function(){
  const dd = document.querySelector('.dropdown');
  if(!dd) return;
  let hydrated = false;
  function doHydrate(){
    if(hydrated) return;
    const items = Array.from(document.querySelectorAll('.chk-item[data-username]'));
    const usernames = items.map(el => el.getAttribute('data-username'));
    if(!usernames.length) return;
    fetch('/user_info_batch', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({usernames})
    }).then(r => r.json()).then(json => {
      const data = (json && json.data) || [];
      data.forEach(row => {
        const el = document.querySelector('.chk-item[data-username="'+row.username+'"]');
        if(!el) return;
        const nameEl = el.querySelector('.name');
        if(nameEl && row.name){ nameEl.textContent = row.name; }
        const img = el.querySelector('img.avatar-sm');
        if(img && row.avatar){ img.src = row.avatar; }
      });
      hydrated = true;
    }).catch(()=>{});
  }
  // Hook to dropdown button
  const btn = document.querySelector('.dropdown-btn');
  if(btn){
    btn.addEventListener('click', doHydrate, {once:false});
  } else {
    // fallback: hydrate on load
    doHydrate();
  }
})();


const pre = document.getElementById('pm-preoct7');
const until = document.getElementById('pm-until');
const LS_PRE = 'pm-preoct7';
function syncPre(){
  if (pre.checked){
    if (until){ until.value = '2023-10-07'; until.disabled = true; }
    localStorage.setItem(LS_PRE, '1');
  } else {
    if (until){ until.disabled = false; }
    localStorage.removeItem(LS_PRE);
  }
}
pre.addEventListener('change', syncPre);
// restore
if (localStorage.getItem(LS_PRE) === '1'){
  pre.checked = true;
  syncPre();
}

    restoreAuthors();
    restoreDate('pm-since', LS_SINCE);
    restoreDate('pm-until', LS_UNTIL);
    storeDate('pm-since', LS_SINCE);
    storeDate('pm-until', LS_UNTIL);
  });
})();
</script>
{% endblock %}
